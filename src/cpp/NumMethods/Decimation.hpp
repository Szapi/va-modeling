/*
 * Copyright (C) 2025 Ték Róbert Máté <eppenpontaz@gmail.com>
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

#pragma once

#include "Utility.hpp"

#include <numeric>

namespace TRM
{

    struct Decimation
    {
    public:
        template<std::size_t Taps>
        class FIR_Base
        {
        public:
            inline double Apply(auto end)
            {
                auto beg = end - Taps;
                return std::inner_product(std::begin(_coeffs), std::end(_coeffs), beg, 0.0);
            }
        protected:
            constexpr FIR_Base(const std::array<double, Taps>& _coeffsIn) : _coeffs{_coeffsIn} {}
        private:
            const std::array<double, Taps>& _coeffs;
        };

        TRM_CONSTEXPR std::size_t D4x_Taps      = 105;
        TRM_CONSTEXPR std::size_t D4x_Poly_Taps = 27;

        struct D4x : public FIR_Base<D4x_Taps>
        {
            TRM_CONSTEXPR std::array<double, D4x_Taps> coeffs = {{
                0.0007589325224462893,
                0.002286074267442946,
                0.0033826242490856027,
                0.0048663705514655695,
                0.005309021855755256,
                0.00480516805522579,
                0.0029933866153971974,
                0.0004634417759766627,
                -0.0020636899377087215,
                -0.003590275407087308,
                -0.0034938957224134558,
                -0.0017276480817566841,
                0.0009935560457884059,
                0.003466331188040143,
                0.004471536520649566,
                0.0033689539110971158,
                0.0004660048489271437,
                -0.0030110407041343684,
                -0.005406480263527812,
                -0.005396222175403833,
                -0.002686721399518115,
                0.001708495464902097,
                0.005806100580951971,
                0.007516884003490526,
                0.0056769985779755675,
                0.0007471146309467735,
                -0.005203118903517638,
                -0.009320427016922076,
                -0.00929097522393258,
                -0.004569758720076178,
                0.003107956468700087,
                0.010284621234052094,
                0.013269364763137278,
                0.009948374668119533,
                0.001064889484072712,
                -0.009732798061335835,
                -0.017272825634327416,
                -0.01719349669995676,
                -0.008234942864250052,
                0.006627674819267409,
                0.020921774672168714,
                0.02721485692271923,
                0.020545410339426248,
                0.0012975926528935129,
                -0.023847659531530205,
                -0.043581629745100506,
                -0.04588362565279871,
                -0.022805717156306925,
                0.025740681918154637,
                0.09083359250658753,
                0.15669681177618142,
                0.20557214728101578,
                0.22360433681744618,
                0.20557214728101578,
                0.15669681177618142,
                0.09083359250658753,
                0.025740681918154637,
                -0.022805717156306925,
                -0.04588362565279871,
                -0.043581629745100506,
                -0.023847659531530205,
                0.0012975926528935129,
                0.020545410339426248,
                0.02721485692271923,
                0.020921774672168714,
                0.006627674819267409,
                -0.008234942864250052,
                -0.01719349669995676,
                -0.017272825634327416,
                -0.009732798061335835,
                0.001064889484072712,
                0.009948374668119533,
                0.013269364763137278,
                0.010284621234052094,
                0.003107956468700087,
                -0.004569758720076178,
                -0.00929097522393258,
                -0.009320427016922076,
                -0.005203118903517638,
                0.0007471146309467735,
                0.0056769985779755675,
                0.007516884003490526,
                0.005806100580951971,
                0.001708495464902097,
                -0.002686721399518115,
                -0.005396222175403833,
                -0.005406480263527812,
                -0.0030110407041343684,
                0.0004660048489271437,
                0.0033689539110971158,
                0.004471536520649566,
                0.003466331188040143,
                0.0009935560457884059,
                -0.0017276480817566841,
                -0.0034938957224134558,
                -0.003590275407087308,
                -0.0020636899377087215,
                0.0004634417759766627,
                0.0029933866153971974,
                0.00480516805522579,
                0.005309021855755256,
                0.0048663705514655695,
                0.0033826242490856027,
                0.002286074267442946,
                0.0007589325224462893
            }};
            constexpr D4x() : FIR_Base(coeffs) {}
        };

        struct D4x_Poly_1 : public FIR_Base<D4x_Poly_Taps>
        {
            TRM_CONSTEXPR std::array<double, D4x_Poly_Taps> coeffs = {{
                0.0007589325224462893,
                0.005309021855755256,
                -0.0020636899377087215,
                0.0009935560457884059,
                0.0004660048489271437,
                -0.002686721399518115,
                0.0056769985779755675,
                -0.00929097522393258,
                0.013269364763137278,
                -0.017272825634327416,
                0.020921774672168714,
                -0.023847659531530205,
                0.025740681918154637,
                0.22360433681744618,
                0.025740681918154637,
                -0.023847659531530205,
                0.020921774672168714,
                -0.017272825634327416,
                0.013269364763137278,
                -0.00929097522393258,
                0.0056769985779755675,
                -0.002686721399518115,
                0.0004660048489271437,
                0.0009935560457884059,
                -0.0020636899377087215,
                0.005309021855755256,
                0.0007589325224462893
            }};
            constexpr D4x_Poly_1() : FIR_Base(coeffs) {}
        };

        struct D4x_Poly_2 : public FIR_Base<D4x_Poly_Taps>
        {
            TRM_CONSTEXPR std::array<double, D4x_Poly_Taps> coeffs = {{
                0.002286074267442946,
                0.00480516805522579,
                -0.003590275407087308,
                0.003466331188040143,
                -0.0030110407041343684,
                0.001708495464902097,
                0.0007471146309467735,
                -0.004569758720076178,
                0.009948374668119533,
                -0.01719349669995676,
                0.02721485692271923,
                -0.043581629745100506,
                0.09083359250658753,
                0.20557214728101578,
                -0.022805717156306925,
                0.0012975926528935129,
                0.006627674819267409,
                -0.009732798061335835,
                0.010284621234052094,
                -0.009320427016922076,
                0.007516884003490526,
                -0.005396222175403833,
                0.0033689539110971158,
                -0.0017276480817566841,
                0.0004634417759766627,
                0.0048663705514655695,
                0.0
            }};
            constexpr D4x_Poly_2() : FIR_Base(coeffs) {}
        };

        struct D4x_Poly_3 : public FIR_Base<D4x_Poly_Taps>
        {
            TRM_CONSTEXPR std::array<double, D4x_Poly_Taps> coeffs = {{
                0.0033826242490856027,
                0.0029933866153971974,
                -0.0034938957224134558,
                0.004471536520649566,
                -0.005406480263527812,
                0.005806100580951971,
                -0.005203118903517638,
                0.003107956468700087,
                0.001064889484072712,
                -0.008234942864250052,
                0.020545410339426248,
                -0.04588362565279871,
                0.15669681177618142,
                0.15669681177618142,
                -0.04588362565279871,
                0.020545410339426248,
                -0.008234942864250052,
                0.001064889484072712,
                0.003107956468700087,
                -0.005203118903517638,
                0.005806100580951971,
                -0.005406480263527812,
                0.004471536520649566,
                -0.0034938957224134558,
                0.0029933866153971974,
                0.0033826242490856027,              
                0.0
            }};
            constexpr D4x_Poly_3() : FIR_Base(coeffs) {}
        };

        struct D4x_Poly_4 : public FIR_Base<D4x_Poly_Taps>
        {
            TRM_CONSTEXPR std::array<double, D4x_Poly_Taps> coeffs = {{
                0.0048663705514655695,
                0.0004634417759766627,
                -0.0017276480817566841,
                0.0033689539110971158,
                -0.005396222175403833,
                0.007516884003490526,
                -0.009320427016922076,
                0.010284621234052094,
                -0.009732798061335835,
                0.006627674819267409,
                0.0012975926528935129,
                -0.022805717156306925,
                0.20557214728101578,
                0.09083359250658753,
                -0.043581629745100506,
                0.02721485692271923,
                -0.01719349669995676,
                0.009948374668119533,
                -0.004569758720076178,
                0.0007471146309467735,
                0.001708495464902097,
                -0.0030110407041343684,
                0.003466331188040143,
                -0.003590275407087308,
                0.00480516805522579,
                0.002286074267442946,                           
                0.0
            }};
            constexpr D4x_Poly_4() : FIR_Base(coeffs) {}
        };
    };

} // namespace TRM