//------------------------------------------------------------------------
// Copyright (C) 2025 Ték Róbert Máté <eppenpontaz@gmail.com>
//
// This program is free software: you can redistribute it and/or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// This program is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU General Public License for more details.
//
// You should have received a copy of the GNU General Public License
// along with this program.  If not, see <http://www.gnu.org/licenses/>.
//------------------------------------------------------------------------

#pragma once

#include <numeric>

namespace TRM
{

    struct Decimation
    {
    public:
        template<std::size_t Taps>
        class Poly_Base
        {
        public:
            inline double Apply(auto end)
            {
                auto beg = end - Taps;
                return std::inner_product(begin(_coeffs), std::end(_coeffs), beg, 0.0);
            }
        protected:
            Poly_Base(const std::array<double, Taps>& _coeffsIn) : _coeffs{_coeffsIn} {}
        private:
            const std::array<double, Taps>& _coeffs;
        };

        inline static constexpr std::size_t D4x_Poly_Taps = 27;
        inline static constexpr std::size_t D2x_Poly_Taps = 27;

    public:

        inline static constexpr unsigned D2x_Size = 53;

        inline static constexpr std::array<double, D2x_Size> D2x_coeffs = {{
            0.0017537939320576863,
            0.007340938089113929,
            0.010684659857249475,
            0.0059465192664006445,
            -0.004242616663016557,
            -0.006997638595382366,
            0.002026157681616623,
            0.008949616068073098,
            0.0008912997218693121,
            -0.01082811684019906,
            -0.005341942938835928,
            0.011629118328725593,
            0.011319672204048182,
            -0.010437864918854862,
            -0.01855507417411213,
            0.0062640990639975,
            0.026534382918826812,
            0.002082360459837173,
            -0.034558207485434624,
            -0.016429660182211446,
            0.04186999401097673,
            0.04105973748393176,
            -0.04773119656100209,
            -0.09174975610860517,
            0.051520616641375305,
            0.31338828169865396,
            0.4471688410545182,
            0.31338828169865396,
            0.051520616641375305,
            -0.09174975610860517,
            -0.04773119656100209,
            0.04105973748393176,
            0.04186999401097673,
            -0.016429660182211446,
            -0.034558207485434624,
            0.002082360459837173,
            0.026534382918826812,
            0.0062640990639975,
            -0.01855507417411213,
            -0.010437864918854862,
            0.011319672204048182,
            0.011629118328725593,
            -0.005341942938835928,
            -0.01082811684019906,
            0.0008912997218693121,
            0.008949616068073098,
            0.002026157681616623,
            -0.006997638595382366,
            -0.004242616663016557,
            0.0059465192664006445,
            0.010684659857249475,
            0.007340938089113929,
            0.0017537939320576863
        }};

        struct D2x_Poly_1 : public Poly_Base<D2x_Poly_Taps>
        {
        private:
            inline static constexpr std::array<double, D2x_Poly_Taps> coeffs = {{
                0.0017537939320576863,
                0.010684659857249475,
                -0.004242616663016557,
                0.002026157681616623,
                0.0008912997218693121,
                -0.005341942938835928,
                0.011319672204048182,
                -0.01855507417411213,
                0.026534382918826812,
                -0.034558207485434624,
                0.04186999401097673,
                -0.04773119656100209,
                0.051520616641375305,
                0.4471688410545182,
                0.051520616641375305,
                -0.04773119656100209,
                0.04186999401097673,
                -0.034558207485434624,
                0.026534382918826812,
                -0.01855507417411213,
                0.011319672204048182,
                -0.005341942938835928,
                0.0008912997218693121,
                0.002026157681616623,
                -0.004242616663016557,
                0.010684659857249475,
                0.0017537939320576863
            }};
        public:
            D2x_Poly_1() : Poly_Base(coeffs) {}
        };

        struct D2x_Poly_2 : public Poly_Base<D2x_Poly_Taps>
        {
        private:
            inline static constexpr std::array<double, D2x_Poly_Taps> coeffs = {{
                0.007340938089113929,
                0.0059465192664006445,
                -0.006997638595382366,
                0.008949616068073098,
                -0.01082811684019906,
                0.011629118328725593,
                -0.010437864918854862,
                0.0062640990639975,
                0.002082360459837173,
                -0.016429660182211446,
                0.04105973748393176,
                -0.09174975610860517,
                0.31338828169865396,
                0.31338828169865396,
                -0.09174975610860517,
                0.04105973748393176,
                -0.016429660182211446,
                0.002082360459837173,
                0.0062640990639975,
                -0.010437864918854862,
                0.011629118328725593,
                -0.01082811684019906,
                0.008949616068073098,
                -0.006997638595382366,
                0.0059465192664006445,
                0.007340938089113929,
                0.0
            }};
        public:
            D2x_Poly_2() : Poly_Base(coeffs) {}
        };



        inline static constexpr unsigned D4x_Size = 105;

        inline static constexpr std::array<double, D4x_Size> D4x_coeffs = {{
            0.0007589325224462893,
            0.002286074267442946,
            0.0033826242490856027,
            0.0048663705514655695,
            0.005309021855755256,
            0.00480516805522579,
            0.0029933866153971974,
            0.0004634417759766627,
            -0.0020636899377087215,
            -0.003590275407087308,
            -0.0034938957224134558,
            -0.0017276480817566841,
            0.0009935560457884059,
            0.003466331188040143,
            0.004471536520649566,
            0.0033689539110971158,
            0.0004660048489271437,
            -0.0030110407041343684,
            -0.005406480263527812,
            -0.005396222175403833,
            -0.002686721399518115,
            0.001708495464902097,
            0.005806100580951971,
            0.007516884003490526,
            0.0056769985779755675,
            0.0007471146309467735,
            -0.005203118903517638,
            -0.009320427016922076,
            -0.00929097522393258,
            -0.004569758720076178,
            0.003107956468700087,
            0.010284621234052094,
            0.013269364763137278,
            0.009948374668119533,
            0.001064889484072712,
            -0.009732798061335835,
            -0.017272825634327416,
            -0.01719349669995676,
            -0.008234942864250052,
            0.006627674819267409,
            0.020921774672168714,
            0.02721485692271923,
            0.020545410339426248,
            0.0012975926528935129,
            -0.023847659531530205,
            -0.043581629745100506,
            -0.04588362565279871,
            -0.022805717156306925,
            0.025740681918154637,
            0.09083359250658753,
            0.15669681177618142,
            0.20557214728101578,
            0.22360433681744618,
            0.20557214728101578,
            0.15669681177618142,
            0.09083359250658753,
            0.025740681918154637,
            -0.022805717156306925,
            -0.04588362565279871,
            -0.043581629745100506,
            -0.023847659531530205,
            0.0012975926528935129,
            0.020545410339426248,
            0.02721485692271923,
            0.020921774672168714,
            0.006627674819267409,
            -0.008234942864250052,
            -0.01719349669995676,
            -0.017272825634327416,
            -0.009732798061335835,
            0.001064889484072712,
            0.009948374668119533,
            0.013269364763137278,
            0.010284621234052094,
            0.003107956468700087,
            -0.004569758720076178,
            -0.00929097522393258,
            -0.009320427016922076,
            -0.005203118903517638,
            0.0007471146309467735,
            0.0056769985779755675,
            0.007516884003490526,
            0.005806100580951971,
            0.001708495464902097,
            -0.002686721399518115,
            -0.005396222175403833,
            -0.005406480263527812,
            -0.0030110407041343684,
            0.0004660048489271437,
            0.0033689539110971158,
            0.004471536520649566,
            0.003466331188040143,
            0.0009935560457884059,
            -0.0017276480817566841,
            -0.0034938957224134558,
            -0.003590275407087308,
            -0.0020636899377087215,
            0.0004634417759766627,
            0.0029933866153971974,
            0.00480516805522579,
            0.005309021855755256,
            0.0048663705514655695,
            0.0033826242490856027,
            0.002286074267442946,
            0.0007589325224462893
        }};

        inline constexpr double D4x(const auto& s) noexcept
        {
            return StencilProduct<
                0.0007589325224462893,
                0.002286074267442946,
                0.0033826242490856027,
                0.0048663705514655695,
                0.005309021855755256,
                0.00480516805522579,
                0.0029933866153971974,
                0.0004634417759766627,
                -0.0020636899377087215,
                -0.003590275407087308,
                -0.0034938957224134558,
                -0.0017276480817566841,
                0.0009935560457884059,
                0.003466331188040143,
                0.004471536520649566,
                0.0033689539110971158,
                0.0004660048489271437,
                -0.0030110407041343684,
                -0.005406480263527812,
                -0.005396222175403833,
                -0.002686721399518115,
                0.001708495464902097,
                0.005806100580951971,
                0.007516884003490526,
                0.0056769985779755675,
                0.0007471146309467735,
                -0.005203118903517638,
                -0.009320427016922076,
                -0.00929097522393258,
                -0.004569758720076178,
                0.003107956468700087,
                0.010284621234052094,
                0.013269364763137278,
                0.009948374668119533,
                0.001064889484072712,
                -0.009732798061335835,
                -0.017272825634327416,
                -0.01719349669995676,
                -0.008234942864250052,
                0.006627674819267409,
                0.020921774672168714,
                0.02721485692271923,
                0.020545410339426248,
                0.0012975926528935129,
                -0.023847659531530205,
                -0.043581629745100506,
                -0.04588362565279871,
                -0.022805717156306925,
                0.025740681918154637,
                0.09083359250658753,
                0.15669681177618142,
                0.20557214728101578,
                0.22360433681744618,
                0.20557214728101578,
                0.15669681177618142,
                0.09083359250658753,
                0.025740681918154637,
                -0.022805717156306925,
                -0.04588362565279871,
                -0.043581629745100506,
                -0.023847659531530205,
                0.0012975926528935129,
                0.020545410339426248,
                0.02721485692271923,
                0.020921774672168714,
                0.006627674819267409,
                -0.008234942864250052,
                -0.01719349669995676,
                -0.017272825634327416,
                -0.009732798061335835,
                0.001064889484072712,
                0.009948374668119533,
                0.013269364763137278,
                0.010284621234052094,
                0.003107956468700087,
                -0.004569758720076178,
                -0.00929097522393258,
                -0.009320427016922076,
                -0.005203118903517638,
                0.0007471146309467735,
                0.0056769985779755675,
                0.007516884003490526,
                0.005806100580951971,
                0.001708495464902097,
                -0.002686721399518115,
                -0.005396222175403833,
                -0.005406480263527812,
                -0.0030110407041343684,
                0.0004660048489271437,
                0.0033689539110971158,
                0.004471536520649566,
                0.003466331188040143,
                0.0009935560457884059,
                -0.0017276480817566841,
                -0.0034938957224134558,
                -0.003590275407087308,
                -0.0020636899377087215,
                0.0004634417759766627,
                0.0029933866153971974,
                0.00480516805522579,
                0.005309021855755256,
                0.0048663705514655695,
                0.0033826242490856027,
                0.002286074267442946,
                0.0007589325224462893
            >(s);
        }

        struct D4x_Poly_1 : public Poly_Base<D4x_Poly_Taps>
        {
        public:
            inline static constexpr std::array<double, D4x_Poly_Taps> coeffs = {{
                0.0007589325224462893,
                0.005309021855755256,
                -0.0020636899377087215,
                0.0009935560457884059,
                0.0004660048489271437,
                -0.002686721399518115,
                0.0056769985779755675,
                -0.00929097522393258,
                0.013269364763137278,
                -0.017272825634327416,
                0.020921774672168714,
                -0.023847659531530205,
                0.025740681918154637,
                0.22360433681744618,
                0.025740681918154637,
                -0.023847659531530205,
                0.020921774672168714,
                -0.017272825634327416,
                0.013269364763137278,
                -0.00929097522393258,
                0.0056769985779755675,
                -0.002686721399518115,
                0.0004660048489271437,
                0.0009935560457884059,
                -0.0020636899377087215,
                0.005309021855755256,
                0.0007589325224462893
            }};
        public:
            D4x_Poly_1() : Poly_Base(coeffs) {}
        };

        struct D4x_Poly_2 : public Poly_Base<D4x_Poly_Taps>
        {
        public:
            inline static constexpr std::array<double, D4x_Poly_Taps> coeffs = {{
                0.002286074267442946,
                0.00480516805522579,
                -0.003590275407087308,
                0.003466331188040143,
                -0.0030110407041343684,
                0.001708495464902097,
                0.0007471146309467735,
                -0.004569758720076178,
                0.009948374668119533,
                -0.01719349669995676,
                0.02721485692271923,
                -0.043581629745100506,
                0.09083359250658753,
                0.20557214728101578,
                -0.022805717156306925,
                0.0012975926528935129,
                0.006627674819267409,
                -0.009732798061335835,
                0.010284621234052094,
                -0.009320427016922076,
                0.007516884003490526,
                -0.005396222175403833,
                0.0033689539110971158,
                -0.0017276480817566841,
                0.0004634417759766627,
                0.0048663705514655695,
                0.0
            }};
        public:
            D4x_Poly_2() : Poly_Base(coeffs) {}
        };

        struct D4x_Poly_3 : public Poly_Base<D4x_Poly_Taps>
        {
        public:
            inline static constexpr std::array<double, D4x_Poly_Taps> coeffs = {{
                0.0033826242490856027,
                0.0029933866153971974,
                -0.0034938957224134558,
                0.004471536520649566,
                -0.005406480263527812,
                0.005806100580951971,
                -0.005203118903517638,
                0.003107956468700087,
                0.001064889484072712,
                -0.008234942864250052,
                0.020545410339426248,
                -0.04588362565279871,
                0.15669681177618142,
                0.15669681177618142,
                -0.04588362565279871,
                0.020545410339426248,
                -0.008234942864250052,
                0.001064889484072712,
                0.003107956468700087,
                -0.005203118903517638,
                0.005806100580951971,
                -0.005406480263527812,
                0.004471536520649566,
                -0.0034938957224134558,
                0.0029933866153971974,
                0.0033826242490856027,
                0.0
            }};
        public:
            D4x_Poly_3() : Poly_Base(coeffs) {}
        };

        struct D4x_Poly_4 : public Poly_Base<D4x_Poly_Taps>
        {
        public:
            inline static constexpr std::array<double, D4x_Poly_Taps> coeffs = {{
                0.0048663705514655695,
                0.0004634417759766627,
                -0.0017276480817566841,
                0.0033689539110971158,
                -0.005396222175403833,
                0.007516884003490526,
                -0.009320427016922076,
                0.010284621234052094,
                -0.009732798061335835,
                0.006627674819267409,
                0.0012975926528935129,
                -0.022805717156306925,
                0.20557214728101578,
                0.09083359250658753,
                -0.043581629745100506,
                0.02721485692271923,
                -0.01719349669995676,
                0.009948374668119533,
                -0.004569758720076178,
                0.0007471146309467735,
                0.001708495464902097,
                -0.0030110407041343684,
                0.003466331188040143,
                -0.003590275407087308,
                0.00480516805522579,
                0.002286074267442946,
                0.0
            }};
        public:
            D4x_Poly_4() : Poly_Base(coeffs) {}
        };
    };

} // namespace TRM